{% extends 'base.html' %}
{% load static %}

{% block title %}Formulario de Registro de Personal{% endblock %}

{% block content %}
<!-- Modal de Carga -->
<div id="loadingModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-body">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h4 class="mb-2">Procesando Registro</h4>
                <p class="text-muted mb-0">Estamos guardando su información y subiendo los documentos. Esto puede tomar unos momentos dependiendo de su conexión.</p>
                <p class="text-danger mt-2 fw-bold"><i class="fas fa-exclamation-circle"></i> Por favor NO cierre ni recargue esta página.</p>
            </div>
        </div>
    </div>
</div>

<div class="main-container">
    <div class="form-header">
        <h1>
            <i class="fas fa-users"></i>
            Registro de Personal - Gestión Humana
        </h1>
        <p>
            Complete la siguiente información para registrarse en nuestra base de datos de personal (*campos obligatorios)
        </p>
    </div>

    <div class="form-container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'warning' %}
                        <i class="fas fa-exclamation-triangle"></i> {{ message }}
                    {% else %}
                        <i class="fas fa-exclamation-circle"></i> {{ message }}
                    {% endif %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="personalForm" novalidate>
            {% csrf_token %}

            <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-user-circle"></i> Información Personal y Profesional
                </h2>
                <p class="text-muted mb-4">Por favor ingrese sus datos personales y perfil profesional</p>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.primer_apellido.id_for_label }}" class="form-label required-field">
                            Primer Apellido
                        </label>
                        {{ form.primer_apellido }}
                        {% if form.primer_apellido.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.primer_apellido.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.segundo_apellido.id_for_label }}" class="form-label required-field">
                            Segundo Apellido
                        </label>
                        {{ form.segundo_apellido }}
                        {% if form.segundo_apellido.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.segundo_apellido.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.primer_nombre.id_for_label }}" class="form-label required-field">
                            Primer Nombre
                        </label>
                        {{ form.primer_nombre }}
                        {% if form.primer_nombre.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.primer_nombre.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.segundo_nombre.id_for_label }}" class="form-label">
                            Segundo Nombre (Opcional)
                        </label>
                        {{ form.segundo_nombre }}
                        {% if form.segundo_nombre.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.segundo_nombre.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.cedula.id_for_label }}" class="form-label required-field">
                            {{ form.cedula.label }}
                        </label>
                        {{ form.cedula }}
                        <small class="form-text text-muted">Entre 5 y 10 dígitos</small>
                        {% if form.cedula.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.cedula.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.genero.id_for_label }}" class="form-label required-field">
                            {{ form.genero.label }}
                        </label>
                        {{ form.genero }}
                        {% if form.genero.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.genero.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.telefono.id_for_label }}" class="form-label required-field">
                            {{ form.telefono.label }}
                        </label>
                        {{ form.telefono }}
                        <small class="form-text text-muted">Exactamente 10 dígitos</small>
                        {% if form.telefono.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.telefono.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.correo.id_for_label }}" class="form-label required-field">
                            {{ form.correo.label }}
                        </label>
                        {{ form.correo }}
                        <small class="form-text text-muted">Debe contener @</small>
                        {% if form.correo.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.correo.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label required-field">
                            <i class="fas fa-map-marker-alt"></i> Dirección Completa
                        </label>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="{{ form.tipo_via.id_for_label }}" class="form-label required-field">
                            {{ form.tipo_via.label }}
                        </label>
                        {{ form.tipo_via }}
                        {% if form.tipo_via.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.tipo_via.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.numero_via.id_for_label }}" class="form-label required-field">
                            {{ form.numero_via.label }}
                        </label>
                        {{ form.numero_via }}
                        {% if form.numero_via.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.numero_via.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.numero_casa.id_for_label }}" class="form-label required-field">
                            {{ form.numero_casa.label }}
                        </label>
                        {{ form.numero_casa }}
                        {% if form.numero_casa.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.numero_casa.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="{{ form.complemento_direccion.id_for_label }}" class="form-label">
                            {{ form.complemento_direccion.label }}
                        </label>
                        {{ form.complemento_direccion }}
                        <small class="form-text">Opcional</small>
                        {% if form.complemento_direccion.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.complemento_direccion.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.barrio.id_for_label }}" class="form-label">
                            {{ form.barrio.label }}
                        </label>
                        {{ form.barrio }}
                        <small class="form-text">Opcional</small>
                        {% if form.barrio.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.barrio.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- NOTA: La sección de perfil profesional será completada por el personal administrativo -->

            <!-- SECCIÓN 2: DOCUMENTOS DE IDENTIDAD Y AUTORIZACIÓN -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-id-card"></i> Documentos de Identidad y Autorización
                </h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-file-alt"></i>
                    Adjunte los documentos de identificación requeridos para el proceso de contratación
                </p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ documentos_form.fotocopia_cedula.id_for_label }}" class="form-label required-field">
                            {{ documentos_form.fotocopia_cedula.label }} *
                        </label>
                        {{ documentos_form.fotocopia_cedula }}
                        <small class="form-text">{{ documentos_form.fotocopia_cedula.help_text|safe }}</small>
                        {% if documentos_form.fotocopia_cedula.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.fotocopia_cedula.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ documentos_form.hoja_de_vida.id_for_label }}" class="form-label required-field">
                            {{ documentos_form.hoja_de_vida.label }} *
                        </label>
                        {{ documentos_form.hoja_de_vida }}
                        <small class="form-text text-muted">{{ documentos_form.hoja_de_vida.help_text }}</small>
                        {% if documentos_form.hoja_de_vida.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.hoja_de_vida.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Sección de Libreta Militar (solo para hombres) -->
                <div id="seccion-libreta-militar" style="display: none;">
                    <hr class="my-4">
                    <h5 class="mb-3">
                        <i class="fas fa-shield-alt"></i> Situación Militar
                        <small class="text-muted">(Opcional)</small>
                    </h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ documentos_form.libreta_militar.id_for_label }}" class="form-label">
                                {{ documentos_form.libreta_militar.label }}
                            </label>
                            {{ documentos_form.libreta_militar }}
                            <small class="form-text text-muted">{{ documentos_form.libreta_militar.help_text }}</small>
                            {% if documentos_form.libreta_militar.errors %}
                                <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.libreta_militar.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ documentos_form.numero_libreta_militar.id_for_label }}" class="form-label">
                                {{ documentos_form.numero_libreta_militar.label }}
                            </label>
                            {{ documentos_form.numero_libreta_militar }}
                            {% if documentos_form.numero_libreta_militar.errors %}
                                <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.numero_libreta_militar.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ documentos_form.distrito_militar.id_for_label }}" class="form-label">
                                {{ documentos_form.distrito_militar.label }}
                            </label>
                            {{ documentos_form.distrito_militar }}
                            {% if documentos_form.distrito_militar.errors %}
                                <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.distrito_militar.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ documentos_form.clase_libreta.id_for_label }}" class="form-label">
                                {{ documentos_form.clase_libreta.label }}
                            </label>
                            {{ documentos_form.clase_libreta }}
                            {% if documentos_form.clase_libreta.errors %}
                                <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ documentos_form.clase_libreta.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 3: EXPERIENCIA LABORAL -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-history"></i> Experiencia Laboral
                </h2>
                <p class="text-muted mb-3">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Agregue toda su experiencia laboral relevante.</strong>
                    Por favor incluya certificados laborales o contractuales que respalden su experiencia.
                </p>
                
                <div class="alert alert-warning mb-3" role="alert">
                    <i class="fas fa-exclamation-circle"></i> <strong>Nota Aclaratoria:</strong>
                    Si la experiencia laboral que va a cargar está relacionada con procesos realizados en los <strong>comedores comunitarios en contrato con la Arquidiócesis de Cali</strong>, NO es necesario que adjunte dicha experiencia ni los soportes correspondientes.
                </div>

                <div class="alert alert-info mb-3" role="alert">
                    <i class="fas fa-info-circle"></i> <strong>Importante:</strong> Todos los campos marcados con <span class="text-danger">*</span> son obligatorios.
                    Si hay un error de validación, deberá volver a adjuntar el archivo del certificado laboral.
                </div>

                <div id="experiencia-container">
                    {{ experiencia_formset.management_form }}
                    {% for form in experiencia_formset %}
                        <div class="experiencia-group">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-briefcase"></i> Experiencia {{ forloop.counter }}
                                </h5>
                                {% if not forloop.first %}
                                    <button type="button" class="remove-btn remove-experiencia">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Errores no relacionados a campos específicos -->
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-circle"></i> {{ form.non_field_errors }}
                                </div>
                            {% endif %}

                            {{ form.id }}
                            {% if form.DELETE %}
                                {{ form.DELETE }}
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">{{ form.cargo.label }} *</label>
                                    {{ form.cargo }}
                                    {% if form.cargo.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.cargo.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3" style="display: none;">
                                    <label class="form-label required-field">{{ form.cargo_anexo_11.label }} *</label>
                                    {{ form.cargo_anexo_11 }}
                                    {% if form.cargo_anexo_11.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.cargo_anexo_11.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">{{ form.fecha_inicial.label }} *</label>
                                    {{ form.fecha_inicial }}
                                    {% if form.fecha_inicial.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.fecha_inicial.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">{{ form.fecha_terminacion.label }} *</label>
                                    {{ form.fecha_terminacion }}
                                    {% if form.fecha_terminacion.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.fecha_terminacion.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">{{ form.meses_experiencia.label }} *</label>
                                    {{ form.meses_experiencia }}
                                    <small class="form-text text-muted">Meses completos de experiencia</small>
                                    {% if form.meses_experiencia.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.meses_experiencia.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">{{ form.dias_experiencia.label }} *</label>
                                    {{ form.dias_experiencia }}
                                    <small class="form-text text-muted">Total de días calendario</small>
                                    {% if form.dias_experiencia.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.dias_experiencia.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label required-field">{{ form.objeto_contractual.label }} *</label>
                                    {{ form.objeto_contractual }}
                                    {% if form.objeto_contractual.help_text %}
                                        <small class="form-text text-warning d-block mt-1">
                                            <i class="fas fa-info-circle"></i> {{ form.objeto_contractual.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.objeto_contractual.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.objeto_contractual.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label required-field">{{ form.funciones.label }} *</label>
                                    {{ form.funciones }}
                                    {% if form.funciones.help_text %}
                                        <small class="form-text text-warning d-block mt-1">
                                            <i class="fas fa-info-circle"></i> {{ form.funciones.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.funciones.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.funciones.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label required-field">{{ form.certificado_laboral.label }} *</label>
                                    {{ form.certificado_laboral }}
                                    <small class="form-text text-muted">Formatos permitidos: PDF, JPG, PNG. Tamaño máximo: 10 MB</small>
                                    {% if form.certificado_laboral.errors %}
                                        <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ form.certificado_laboral.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="text-center mt-3">
                    <button type="button" class="add-btn" id="add-experiencia">
                        <i class="fas fa-plus-circle"></i> Agregar Más Experiencia Laboral
                    </button>
                </div>
            </div>

            <!-- SECCIÓN 4: FORMACIÓN ACADÉMICA (Acordeón) -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-graduation-cap"></i> Formación Académica
                </h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-university"></i>
                    Por favor registre todos sus niveles de formación académica.
                </p>

                <div class="accordion" id="accordionAcademic">
                    
                    <!-- 1. Educación Básica (Bachiller) -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBasica">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasica" aria-expanded="true" aria-controls="collapseBasica">
                                <i class="fas fa-school me-2"></i> 1. Educación Básica (Bachiller)
                            </button>
                        </h2>
                        <div id="collapseBasica" class="accordion-collapse collapse show" aria-labelledby="headingBasica" data-bs-parent="#accordionAcademic">
                            <div class="accordion-body">
                                <div id="basica-container">
                                    {{ basica_formset.management_form }}
                                    {% for form in basica_formset %}
                                        <div class="basica-group border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Bachiller {{ forloop.counter }}</h6>
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-basica"><i class="fas fa-trash"></i></button>
                                                {% endif %}
                                            </div>
                                            {{ form.id }}
                                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">{{ form.institucion.label }}</label>
                                                    {{ form.institucion }}
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label">{{ form.anio_grado.label }}</label>
                                                    {{ form.anio_grado }}
                                                </div>
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label">{{ form.titulo.label }}</label>
                                                    {{ form.titulo }}
                                                </div>
                                                <div class="col-md-12 mb-2">
                                                    <label class="form-label">{{ form.acta_grado_diploma.label }}</label>
                                                    {{ form.acta_grado_diploma }}
                                                    <small class="text-muted">PDF, JPG, PNG (Max 10MB)</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-basica">
                                    <i class="fas fa-plus"></i> Agregar Otro Bachiller
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Educación Superior (Técnico / Tecnólogo) -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSuperior">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSuperior" aria-expanded="false" aria-controls="collapseSuperior">
                                <i class="fas fa-cogs me-2"></i> 2. Educación Superior (Técnico / Tecnólogo)
                            </button>
                        </h2>
                        <div id="collapseSuperior" class="accordion-collapse collapse" aria-labelledby="headingSuperior" data-bs-parent="#accordionAcademic">
                            <div class="accordion-body">
                                <div id="superior-container">
                                    {{ superior_formset.management_form }}
                                    {% for form in superior_formset %}
                                        <div class="superior-group border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Título {{ forloop.counter }}</h6>
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-superior"><i class="fas fa-trash"></i></button>
                                                {% endif %}
                                            </div>
                                            {{ form.id }}
                                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                            <div class="row">
                                                <div class="col-md-3 mb-2">
                                                    <label class="form-label">{{ form.nivel.label }}</label>
                                                    {{ form.nivel }}
                                                </div>
                                                <div class="col-md-5 mb-2">
                                                    <label class="form-label">{{ form.institucion.label }}</label>
                                                    {{ form.institucion }}
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <label class="form-label">{{ form.titulo.label }}</label>
                                                    {{ form.titulo }}
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <label class="form-label">{{ form.fecha_grado.label }}</label>
                                                    {{ form.fecha_grado }}
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <label class="form-label">{{ form.tarjeta_profesional.label }}</label>
                                                    {{ form.tarjeta_profesional }}
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <label class="form-label">{{ form.documento_soporte.label }}</label>
                                                    {{ form.documento_soporte }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-superior">
                                    <i class="fas fa-plus"></i> Agregar Técnico/Tecnólogo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Pregrado (Universitario) -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingPregrado">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePregrado" aria-expanded="false" aria-controls="collapsePregrado">
                                <i class="fas fa-user-graduate me-2"></i> 3. Pregrado (Profesional Universitario)
                            </button>
                        </h2>
                        <div id="collapsePregrado" class="accordion-collapse collapse" aria-labelledby="headingPregrado" data-bs-parent="#accordionAcademic">
                            <div class="accordion-body">
                                <div id="academica-container">
                                    {{ academica_formset.management_form }}
                                    {% for form in academica_formset %}
                                        <div class="academica-group border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Pregrado {{ forloop.counter }}</h6>
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-academica"><i class="fas fa-trash"></i></button>
                                                {% endif %}
                                            </div>
                                            {{ form.id }}
                                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label required-field">{{ form.profesion.label }} *</label>
                                                    {{ form.profesion }}
                                                    {% if form.profesion.errors %}<div class="text-danger">{{ form.profesion.errors }}</div>{% endif %}
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label required-field">{{ form.universidad.label }} *</label>
                                                    {{ form.universidad }}
                                                    {% if form.universidad.errors %}<div class="text-danger">{{ form.universidad.errors }}</div>{% endif %}
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">{{ form.tarjeta_profesional.label }}</label>
                                                    {{ form.tarjeta_profesional }}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">{{ form.numero_tarjeta_resolucion.label }}</label>
                                                    {{ form.numero_tarjeta_resolucion }}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">{{ form.fecha_expedicion.label }}</label>
                                                    {{ form.fecha_expedicion }}
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label required-field">{{ form.fecha_grado.label }} *</label>
                                                    {{ form.fecha_grado }}
                                                    {% if form.fecha_grado.errors %}<div class="text-danger">{{ form.fecha_grado.errors }}</div>{% endif %}
                                                </div>
                                            </div>

                                            <!-- Documentos Académicos -->
                                            <div class="row bg-light p-2 rounded">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">{{ form.fotocopia_titulo.label }}</label>
                                                    {{ form.fotocopia_titulo }}
                                                    <small class="form-text text-muted">Diploma/Acta de Grado</small>
                                                </div>
                                                <div class="col-md-6 mb-3 campo-tarjeta-doc">
                                                    <label class="form-label">{{ form.fotocopia_tarjeta_profesional.label }}</label>
                                                    {{ form.fotocopia_tarjeta_profesional }}
                                                </div>
                                                <div class="col-md-6 mb-3 campo-vigencia-doc">
                                                    <label class="form-label">{{ form.certificado_vigencia_tarjeta.label }}</label>
                                                    {{ form.certificado_vigencia_tarjeta }}
                                                </div>
                                                <div class="col-md-6 mb-3 campo-vigencia-doc">
                                                    <label class="form-label">{{ form.fecha_vigencia_tarjeta.label }}</label>
                                                    {{ form.fecha_vigencia_tarjeta }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-academica">
                                    <i class="fas fa-plus"></i> Agregar Pregrado
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Especializaciones -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingEspecializacion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEspecializacion" aria-expanded="false" aria-controls="collapseEspecializacion">
                                <i class="fas fa-certificate me-2"></i> 4. Especializaciones
                            </button>
                        </h2>
                        <div id="collapseEspecializacion" class="accordion-collapse collapse" aria-labelledby="headingEspecializacion" data-bs-parent="#accordionAcademic">
                            <div class="accordion-body">
                                <div id="especializacion-container">
                                    {{ especializacion_formset.management_form }}
                                    {% for form in especializacion_formset %}
                                        <div class="especializacion-group border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Especialización {{ forloop.counter }}</h6>
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-especializacion"><i class="fas fa-trash"></i></button>
                                                {% endif %}
                                            </div>
                                            {{ form.id }}
                                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.nombre_especializacion.label }} *</label>
                                                    {{ form.nombre_especializacion }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.universidad.label }} *</label>
                                                    {{ form.universidad }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.fecha_terminacion.label }} *</label>
                                                    {{ form.fecha_terminacion }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.acta_grado_diploma.label }} *</label>
                                                    {{ form.acta_grado_diploma }}
                                                    <small class="text-muted d-block">PDF, JPG, PNG (Max 10MB)</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-especializacion">
                                    <i class="fas fa-plus"></i> Agregar Especialización
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Posgrados (Maestrías/Doctorados) -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingPosgrado">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePosgrado" aria-expanded="false" aria-controls="collapsePosgrado">
                                <i class="fas fa-award me-2"></i> 5. Posgrados (Maestrías / Doctorados)
                            </button>
                        </h2>
                        <div id="collapsePosgrado" class="accordion-collapse collapse" aria-labelledby="headingPosgrado" data-bs-parent="#accordionAcademic">
                            <div class="accordion-body">
                                <div id="posgrado-container">
                                    {{ posgrado_formset.management_form }}
                                    {% for form in posgrado_formset %}
                                        <div class="posgrado-group border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Posgrado {{ forloop.counter }}</h6>
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-posgrado"><i class="fas fa-trash"></i></button>
                                                {% endif %}
                                            </div>
                                            {{ form.id }}
                                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.nombre_posgrado.label }} *</label>
                                                    {{ form.nombre_posgrado }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.universidad.label }} *</label>
                                                    {{ form.universidad }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.fecha_terminacion.label }} *</label>
                                                    {{ form.fecha_terminacion }}
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label required-field">{{ form.acta_grado_diploma.label }} *</label>
                                                    {{ form.acta_grado_diploma }}
                                                    <small class="text-muted d-block">PDF, JPG, PNG (Max 10MB)</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-posgrado">
                                    <i class="fas fa-plus"></i> Agregar Posgrado
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- SECCIÓN 7: ANTECEDENTES Y VERIFICACIONES -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i> Antecedentes y Verificaciones
                </h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-balance-scale"></i>
                    Adjunte los certificados de antecedentes requeridos para el proceso de contratación
                </p>
                <div class="alert alert-warning mb-4" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong>
                    Todos los certificados deben estar vigentes. Puede obtenerlos en línea desde las páginas oficiales de cada entidad.
                </div>

                <!-- Antecedentes Disciplinarios - Procuraduría -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_procuraduria.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_procuraduria.label }} *
                        </label>
                        {{ antecedentes_form.certificado_procuraduria }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_procuraduria.help_text }}</small>
                        {% if antecedentes_form.certificado_procuraduria.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_procuraduria.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_procuraduria.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_procuraduria.label }} *
                        </label>
                        {{ antecedentes_form.fecha_procuraduria }}
                        {% if antecedentes_form.fecha_procuraduria.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_procuraduria.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Antecedentes Fiscales - Contraloría -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_contraloria.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_contraloria.label }} *
                        </label>
                        {{ antecedentes_form.certificado_contraloria }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_contraloria.help_text }}</small>
                        {% if antecedentes_form.certificado_contraloria.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_contraloria.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_contraloria.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_contraloria.label }} *
                        </label>
                        {{ antecedentes_form.fecha_contraloria }}
                        {% if antecedentes_form.fecha_contraloria.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_contraloria.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Antecedentes Judiciales - Policía -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_policia.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_policia.label }} *
                        </label>
                        {{ antecedentes_form.certificado_policia }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_policia.help_text }}</small>
                        {% if antecedentes_form.certificado_policia.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_policia.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_policia.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_policia.label }} *
                        </label>
                        {{ antecedentes_form.fecha_policia }}
                        {% if antecedentes_form.fecha_policia.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_policia.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Medidas Correctivas - RNMC -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_medidas_correctivas.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_medidas_correctivas.label }} *
                        </label>
                        {{ antecedentes_form.certificado_medidas_correctivas }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_medidas_correctivas.help_text }}</small>
                        {% if antecedentes_form.certificado_medidas_correctivas.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_medidas_correctivas.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_medidas_correctivas.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_medidas_correctivas.label }} *
                        </label>
                        {{ antecedentes_form.fecha_medidas_correctivas }}
                        {% if antecedentes_form.fecha_medidas_correctivas.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_medidas_correctivas.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Inhabilidades por Delitos Sexuales -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_delitos_sexuales.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_delitos_sexuales.label }} *
                        </label>
                        {{ antecedentes_form.certificado_delitos_sexuales }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_delitos_sexuales.help_text }}</small>
                        {% if antecedentes_form.certificado_delitos_sexuales.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_delitos_sexuales.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_delitos_sexuales.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_delitos_sexuales.label }} *
                        </label>
                        {{ antecedentes_form.fecha_delitos_sexuales }}
                        {% if antecedentes_form.fecha_delitos_sexuales.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_delitos_sexuales.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Registro de Deudores Alimentarios Morosos (REDAM) -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.certificado_redam.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.certificado_redam.label }} *
                        </label>
                        {{ antecedentes_form.certificado_redam }}
                        <small class="form-text text-muted">{{ antecedentes_form.certificado_redam.help_text }}</small>
                        {% if antecedentes_form.certificado_redam.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.certificado_redam.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ antecedentes_form.fecha_redam.id_for_label }}" class="form-label required-field">
                            {{ antecedentes_form.fecha_redam.label }} *
                        </label>
                        {{ antecedentes_form.fecha_redam }}
                        {% if antecedentes_form.fecha_redam.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ antecedentes_form.fecha_redam.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 8: ANEXOS ADICIONALES -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-folder-open"></i> Anexos Adicionales
                </h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-paperclip"></i>
                    Documentos opcionales adicionales para completar su expediente
                </p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ anexos_form.anexo_03_datos_personales.id_for_label }}" class="form-label">
                            {{ anexos_form.anexo_03_datos_personales.label }}
                        </label>
                        {{ anexos_form.anexo_03_datos_personales }}
                        <small class="form-text text-muted">{{ anexos_form.anexo_03_datos_personales.help_text }}</small>
                        {% if anexos_form.anexo_03_datos_personales.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ anexos_form.anexo_03_datos_personales.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ anexos_form.carta_intencion.id_for_label }}" class="form-label">
                            {{ anexos_form.carta_intencion.label }}
                        </label>
                        {{ anexos_form.carta_intencion }}
                        <small class="form-text text-muted">{{ anexos_form.carta_intencion.help_text }}</small>
                        {% if anexos_form.carta_intencion.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ anexos_form.carta_intencion.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ anexos_form.otros_documentos.id_for_label }}" class="form-label">
                            {{ anexos_form.otros_documentos.label }}
                        </label>
                        {{ anexos_form.otros_documentos }}
                        <small class="form-text text-muted">{{ anexos_form.otros_documentos.help_text }}</small>
                        {% if anexos_form.otros_documentos.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ anexos_form.otros_documentos.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ anexos_form.descripcion_otros.id_for_label }}" class="form-label">
                            {{ anexos_form.descripcion_otros.label }}
                        </label>
                        {{ anexos_form.descripcion_otros }}
                        <small class="form-text d-block mt-2">
                            {{ anexos_form.descripcion_otros.help_text|safe }}
                        </small>
                        {% if anexos_form.descripcion_otros.errors %}
                            <div class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ anexos_form.descripcion_otros.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 9: AUTORIZACIÓN DE DATOS -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-check-circle"></i> Autorización de Tratamiento de Datos
                </h2>
                <div class="alert alert-light border">
                    <div class="form-check">
                        {{ form.acepta_politica }}
                        <label class="form-check-label" for="{{ form.acepta_politica.id_for_label }}">
                            He leído y acepto la 
                            <a href="#" data-bs-toggle="modal" data-bs-target="#politicaModal">Política de Tratamiento de Datos Personales</a>
                            y autorizo el uso de mi información para los procesos de selección y contratación.
                        </label>
                        {% if form.acepta_politica.errors %}
                            <div class="text-danger mt-1"><i class="fas fa-exclamation-triangle"></i> {{ form.acepta_politica.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Modal de Política de Privacidad -->
            <div class="modal fade" id="politicaModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Política de Tratamiento de Datos Personales</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>De conformidad con la Ley 1581 de 2012 y el Decreto 1377 de 2013, manifiesto que he sido informado que:</p>
                            <ol>
                                <li>La Corporación actuará como Responsable del Tratamiento de datos personales de los cuales soy titular.</li>
                                <li>Mis datos serán tratados para fines de selección, contratación y gestión del talento humano.</li>
                                <li>Tengo derecho a conocer, actualizar y rectificar mis datos personales.</li>
                            </ol>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-primary" id="btnAceptarPolitica" data-bs-dismiss="modal">
                                <i class="fas fa-check"></i> Aceptar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div class="text-center mt-5">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle"></i>
                    <strong>Al hacer clic en "Completar Registro", su información será guardada en nuestro sistema.</strong>
                </div>

                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-check-circle"></i> Completar Registro
                </button>
                <button type="reset" class="btn btn-secondary btn-lg ms-3 px-5">
                    <i class="fas fa-undo"></i> Limpiar Formulario
                </button>
            </div>

            <div class="text-center mt-4">
                <p class="text-muted">
                    <i class="fas fa-lock"></i> Sus datos están protegidos y serán utilizados únicamente para procesos de gestión humana.
                </p>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Script para manejar los formsets dinámicos
    $(document).ready(function() {
        // Función genérica para manejar eliminación
        function setupRemoveButtons() {
            $('.remove-experiencia, .remove-academica, .remove-posgrado, .remove-especializacion, .remove-basica, .remove-superior').off('click').on('click', function() {
                var group = $(this).closest('.experiencia-group, .academica-group, .posgrado-group, .especializacion-group, .basica-group, .superior-group');
                var deleteCheckbox = group.find('input[name$="-DELETE"]');
                if (deleteCheckbox.length) {
                    deleteCheckbox.prop('checked', true);
                    group.hide();
                } else {
                    group.remove();
                }
            });
        }

        // Función genérica para agregar formularios
        function setupAddButton(btnId, containerId, formPrefix, groupClass, titlePrefix, iconClass) {
            $('#' + btnId).off('click').on('click', function(e) {
                e.preventDefault();
                var container = $('#' + containerId);
                var totalForms = $('#id_' + formPrefix + '-TOTAL_FORMS');
                var formNum = parseInt(totalForms.val());
                
                // Buscar plantilla
                var lastForm = container.find('.' + groupClass + ':visible').last();
                if (lastForm.length === 0) lastForm = container.find('.' + groupClass).last();
                if (lastForm.length === 0) lastForm = container.find('.' + groupClass).first(); // Fallback

                var newForm = lastForm.clone();
                
                // Actualizar índices
                var regex = new RegExp(formPrefix + '-\\d+-', 'g');
                newForm.html(newForm.html().replace(regex, formPrefix + '-' + formNum + '-'));
                
                // Limpiar campos
                newForm.find('input, textarea, select').val('');
                newForm.find('input[type="checkbox"]').prop('checked', false);
                newForm.find('input[type="file"]').val('');
                newForm.show();

                // Actualizar título y botón de eliminar
                var title = newForm.find('h6, h5');
                if (title.length) {
                    var newTitle = titlePrefix + ' ' + (formNum + 1);
                    // Si el título tenía icono, intentar preservarlo o reconstruirlo simple
                    title.text(newTitle); 
                }
                
                // Asegurar botón de eliminar
                if (newForm.find('.remove-' + groupClass.split('-')[0]).length === 0) {
                    var headerDiv = newForm.find('.d-flex');
                    if(headerDiv.length) {
                        headerDiv.append('<button type="button" class="btn btn-danger btn-sm remove-' + groupClass.split('-')[0] + '"><i class="fas fa-trash"></i></button>');
                    }
                }

                container.append(newForm);
                totalForms.val(formNum + 1);
                setupRemoveButtons();
            });
        }

        // Configurar botones de agregar
        setupAddButton('add-experiencia', 'experiencia-container', 'experiencias_laborales', 'experiencia-group', 'Experiencia', 'briefcase');
        setupAddButton('add-academica', 'academica-container', 'formacion_academica', 'academica-group', 'Pregrado', 'graduation-cap');
        setupAddButton('add-posgrado', 'posgrado-container', 'posgrados', 'posgrado-group', 'Posgrado', 'award');
        setupAddButton('add-especializacion', 'especializacion-container', 'especializaciones', 'especializacion-group', 'Especialización', 'certificate');
        setupAddButton('add-basica', 'basica-container', 'educacion_basica', 'basica-group', 'Bachiller', 'school');
        setupAddButton('add-superior', 'superior-container', 'educacion_superior', 'superior-group', 'Título', 'cogs');

        // Inicializar botones de eliminar
        setupRemoveButtons();

        // Función para calcular la diferencia entre fechas
        function calcularDiferencia(fechaInicio, fechaFin) {
            if (!fechaInicio || !fechaFin) return { meses: 0, dias: 0, totalDias: 0 };

            var inicio = new Date(fechaInicio);
            var fin = new Date(fechaFin);

            if (fin < inicio) return { meses: 0, dias: 0, totalDias: 0 };

            // Calcular el total de días calendario entre las dos fechas
            var unDiaEnMilisegundos = 1000 * 60 * 60 * 24;
            var totalDias = Math.round((fin - inicio) / unDiaEnMilisegundos);

            var años = fin.getFullYear() - inicio.getFullYear();
            var meses = fin.getMonth() - inicio.getMonth();
            var dias = fin.getDate() - inicio.getDate();

            // Ajustar si los días son negativos
            if (dias < 0) {
                meses--;
                var ultimoDiaMesAnterior = new Date(fin.getFullYear(), fin.getMonth(), 0).getDate();
                dias += ultimoDiaMesAnterior;
            }

            // Ajustar si los meses son negativos
            if (meses < 0) {
                años--;
                meses += 12;
            }

            var totalMeses = (años * 12) + meses;

            return { meses: totalMeses, dias: dias, totalDias: totalDias };
        }

        // Calcular automáticamente meses y días de experiencia
        function setupCalculoExperiencia() {
            $(document).on('change', 'input[id*="fecha_inicial"], input[id*="fecha_terminacion"]', function() {
                var experienciaGroup = $(this).closest('.experiencia-group');
                var fechaInicial = experienciaGroup.find('input[id*="fecha_inicial"]').val();
                var fechaTerminacion = experienciaGroup.find('input[id*="fecha_terminacion"]').val();

                if (fechaInicial && fechaTerminacion) {
                    var resultado = calcularDiferencia(fechaInicial, fechaTerminacion);

                    // meses_experiencia: Total de meses completos
                    experienciaGroup.find('input[id*="meses_experiencia"]').val(resultado.meses);

                    // dias_experiencia: Total de días calendario (completos)
                    experienciaGroup.find('input[id*="dias_experiencia"]').val(resultado.totalDias);
                }
            });
        }

        // Inicializar cálculo de experiencia
        setupCalculoExperiencia();

        // Mostrar/ocultar campo de número de tarjeta y documentos según selección (para Pregrado)
        $(document).on('change', 'select[id*="tarjeta_profesional"]', function() {
            var group = $(this).closest('.academica-group, .superior-group'); // Aplica también a técnico/tecnólogo
            if(group.length === 0) return;

            var val = $(this).val();
            // Buscar campos relacionados. Nota: La estructura HTML varía ligeramente entre Pregrado y Técnico
            // Para Pregrado (academica-group)
            if(group.hasClass('academica-group')) {
                var numeroField = group.find('input[id*="numero_tarjeta_resolucion"]').closest('.col-md-4');
                var fechaField = group.find('input[id*="fecha_expedicion"]').closest('.col-md-4');
                var campoTarjetaDoc = group.find('.campo-tarjeta-doc');
                var campoVigenciaDoc = group.find('.campo-vigencia-doc');

                if (val === 'No Aplica') {
                    numeroField.hide(); fechaField.hide(); campoTarjetaDoc.hide(); campoVigenciaDoc.hide();
                    numeroField.find('input').removeAttr('required');
                    fechaField.find('input').removeAttr('required');
                } else {
                    numeroField.show(); fechaField.show(); campoTarjetaDoc.show(); campoVigenciaDoc.show();
                }
            }
        });

        // Inicializar visibilidad de campos de tarjeta
        $('select[id*="tarjeta_profesional"]').each(function() {
            $(this).trigger('change');
        });

        // Agregar estilos de bootstrap a los campos del formulario
        $('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="file"], select, textarea').addClass('form-control');
        $('input[type="checkbox"]').addClass('form-check-input');

        // Mostrar/ocultar sección de libreta militar según género
        function toggleLibretaMilitar() {
            var genero = $('#id_genero').val();
            var seccionLibreta = $('#seccion-libreta-militar');

            if (genero === 'Masculino') {
                seccionLibreta.slideDown();
            } else {
                seccionLibreta.slideUp();
                // Limpiar campos de libreta militar si es mujer
                seccionLibreta.find('input[type="text"]').val('');
                seccionLibreta.find('input[type="file"]').val('');
                seccionLibreta.find('select').val('');
            }
        }

        // Ejecutar al cargar la página
        toggleLibretaMilitar();

        // Ejecutar cuando cambie el género
        $('#id_genero').on('change', toggleLibretaMilitar);

        // Validación personalizada del formulario
        $('#personalForm').on('submit', function(e) {
            var isValid = true;
            var errorMessages = [];

            // ============================================
            // VALIDACIÓN DE CAMPOS DE TEXTO OBLIGATORIOS
            // ============================================

            // Campos de información personal
            var camposTexto = [
                { id: 'id_primer_apellido', nombre: 'Primer Apellido' },
                { id: 'id_segundo_apellido', nombre: 'Segundo Apellido' },
                { id: 'id_primer_nombre', nombre: 'Primer Nombre' },
                { id: 'id_cedula', nombre: 'Cédula' },
                { id: 'id_genero', nombre: 'Género' },
                { id: 'id_telefono', nombre: 'Teléfono' },
                { id: 'id_correo', nombre: 'Correo Electrónico' },
                { id: 'id_tipo_via', nombre: 'Tipo de Vía' },
                { id: 'id_numero_via', nombre: 'Número de Vía' },
                { id: 'id_numero_casa', nombre: 'Número de Casa/Edificio' }
            ];

            camposTexto.forEach(function(campo) {
                var input = $('#' + campo.id);
                if (input.length > 0 && !input.val().trim()) {
                    isValid = false;
                    input.addClass('is-invalid');
                    errorMessages.push('El campo ' + campo.nombre + ' es obligatorio.');
                } else {
                    input.removeClass('is-invalid');
                }
            });

            // Validar formato de cédula (5-10 dígitos)
            var cedula = $('#id_cedula').val();
            if (cedula && (!/^\d+$/.test(cedula) || cedula.length < 5 || cedula.length > 10)) {
                isValid = false;
                $('#id_cedula').addClass('is-invalid');
                if (errorMessages.indexOf('La cédula debe tener entre 5 y 10 dígitos numéricos.') === -1) {
                    errorMessages.push('La cédula debe tener entre 5 y 10 dígitos numéricos.');
                }
            }

            // Validar formato de teléfono (10 dígitos)
            var telefono = $('#id_telefono').val();
            if (telefono && (!/^\d+$/.test(telefono) || telefono.length !== 10)) {
                isValid = false;
                $('#id_telefono').addClass('is-invalid');
                errorMessages.push('El teléfono debe tener exactamente 10 dígitos numéricos.');
            }

            // Validar formato de correo
            var correo = $('#id_correo').val();
            if (correo && correo.indexOf('@') === -1) {
                isValid = false;
                $('#id_correo').addClass('is-invalid');
                errorMessages.push('El correo electrónico debe contener @.');
            }

            // Validar fechas de antecedentes (obligatorias y vigencia 30 días)
            var fechasAntecedentes = [
                { id: 'id_fecha_procuraduria', nombre: 'Fecha de Procuraduría' },
                { id: 'id_fecha_contraloria', nombre: 'Fecha de Contraloría' },
                { id: 'id_fecha_policia', nombre: 'Fecha de Policía' },
                { id: 'id_fecha_medidas_correctivas', nombre: 'Fecha de Medidas Correctivas' },
                { id: 'id_fecha_delitos_sexuales', nombre: 'Fecha de Delitos Sexuales' },
                { id: 'id_fecha_redam', nombre: 'Fecha de REDAM' }
            ];

            var hoy = new Date();
            // Resetear horas para comparar solo fechas
            hoy.setHours(0, 0, 0, 0);
            var treintaDiasAtras = new Date(hoy);
            treintaDiasAtras.setDate(hoy.getDate() - 30);

            fechasAntecedentes.forEach(function(fecha) {
                var input = $('input[id*="' + fecha.id.replace('id_', '') + '"]');
                if (input.length > 0) {
                    var valorFecha = input.val();
                    if (!valorFecha) {
                        isValid = false;
                        input.addClass('is-invalid');
                        errorMessages.push('La ' + fecha.nombre + ' es obligatoria.');
                    } else {
                        // Validar vigencia y fecha futura
                        var fechaIngresada = new Date(valorFecha + 'T00:00:00'); // Agregar hora para evitar problemas de zona horaria
                        
                        if (fechaIngresada > hoy) {
                            isValid = false;
                            input.addClass('is-invalid');
                            errorMessages.push('La ' + fecha.nombre + ' no puede ser una fecha futura.');
                        } else if (fechaIngresada < treintaDiasAtras) {
                            isValid = false;
                            input.addClass('is-invalid');
                            errorMessages.push('El certificado de ' + fecha.nombre + ' tiene más de 30 días de antigüedad.');
                        } else {
                            input.removeClass('is-invalid');
                        }
                    }
                }
            });

            // Validar todas las fechas generales para que no sean futuras
            $('input[type="date"]').each(function() {
                var valor = $(this).val();
                if (valor) {
                    var fecha = new Date(valor + 'T00:00:00');
                    var label = $('label[for="' + $(this).attr('id') + '"]').text().replace('*', '').trim();
                    
                    // Intentar identificar la sección y el número
                    var context = "";
                    var group = $(this).closest('.basica-group, .superior-group, .academica-group, .posgrado-group, .especializacion-group, .experiencia-group');
                    
                    if (group.length) {
                        var title = group.find('h6, h5').first().text().trim(); // Ej: "Bachiller 1"
                        if (title) context = title + ": ";
                    }

                    if (fecha > hoy) {
                        isValid = false;
                        $(this).addClass('is-invalid');
                        var msg = context + 'La fecha "' + label + '" no puede ser futura.';
                        if (errorMessages.indexOf(msg) === -1) {
                            errorMessages.push(msg);
                        }
                    }
                }
            });

            // ============================================
            // VALIDACIÓN DE ARCHIVOS OBLIGATORIOS
            // ============================================

            // Validar fotocopia de cédula (obligatorio)
            var fotocopiaCedula = $('input[type="file"][id*="fotocopia_cedula"]');
            if (fotocopiaCedula.length > 0 && !fotocopiaCedula.val()) {
                isValid = false;
                fotocopiaCedula.addClass('is-invalid');
                errorMessages.push('Debe adjuntar la fotocopia de la cédula de ciudadanía.');
            } else {
                fotocopiaCedula.removeClass('is-invalid');
            }

            // Validar hoja de vida (obligatorio)
            var hojaDeVida = $('input[type="file"][id*="hoja_de_vida"]');
            if (hojaDeVida.length > 0 && !hojaDeVida.val()) {
                isValid = false;
                hojaDeVida.addClass('is-invalid');
                errorMessages.push('Debe adjuntar la hoja de vida.');
            } else {
                hojaDeVida.removeClass('is-invalid');
            }

            // Validar campos obligatorios de Experiencia Laboral
            $('.experiencia-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                // Solo validar si el formulario no está marcado para eliminar
                if (!deleteCheckbox.prop('checked')) {
                    var expNum = index + 1;

                    // Validar cargo
                    var cargo = $(this).find('input[id*="cargo"]').not('[id*="cargo_anexo"]');
                    if (cargo.length > 0 && !cargo.val().trim()) {
                        isValid = false;
                        cargo.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': El campo Cargo es obligatorio.');
                    } else {
                        cargo.removeClass('is-invalid');
                    }

                    // Validar fecha inicial
                    var fechaInicial = $(this).find('input[id*="fecha_inicial"]');
                    if (fechaInicial.length > 0 && !fechaInicial.val()) {
                        isValid = false;
                        fechaInicial.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': La Fecha Inicial es obligatoria.');
                    } else {
                        fechaInicial.removeClass('is-invalid');
                    }

                    // Validar fecha terminación
                    var fechaTerminacion = $(this).find('input[id*="fecha_terminacion"]');
                    if (fechaTerminacion.length > 0 && !fechaTerminacion.val()) {
                        isValid = false;
                        fechaTerminacion.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': La Fecha de Terminación es obligatoria.');
                    } else {
                        fechaTerminacion.removeClass('is-invalid');
                    }

                    // Validar objeto contractual
                    var objetoContractual = $(this).find('textarea[id*="objeto_contractual"]');
                    if (objetoContractual.length > 0 && !objetoContractual.val().trim()) {
                        isValid = false;
                        objetoContractual.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': El Objeto Contractual es obligatorio.');
                    } else {
                        objetoContractual.removeClass('is-invalid');
                    }

                    // Validar funciones
                    var funciones = $(this).find('textarea[id*="funciones"]');
                    if (funciones.length > 0 && !funciones.val().trim()) {
                        isValid = false;
                        funciones.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': Las Funciones son obligatorias.');
                    } else {
                        funciones.removeClass('is-invalid');
                    }

                    // Validar certificado laboral
                    var fileInput = $(this).find('input[type="file"][id*="certificado_laboral"]');
                    var hasExistingFile = $(this).find('a[href*="certificado"]').length > 0;

                    if (fileInput.length > 0 && !fileInput.val() && !hasExistingFile) {
                        isValid = false;
                        fileInput.addClass('is-invalid');
                        errorMessages.push('Experiencia ' + expNum + ': El Certificado Laboral es obligatorio.');
                    } else {
                        fileInput.removeClass('is-invalid');
                    }
                }
            });

            // Validar campos obligatorios de Información Académica
            $('.academica-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                // Solo validar si el formulario no está marcado para eliminar
                if (!deleteCheckbox.prop('checked')) {
                    var acadNum = index + 1;

                    // Validar profesión
                    var profesion = $(this).find('input[id*="profesion"]');
                    if (profesion.length > 0 && !profesion.val().trim()) {
                        isValid = false;
                        profesion.addClass('is-invalid');
                        errorMessages.push('Formación Académica ' + acadNum + ': La Profesión es obligatoria.');
                    } else {
                        profesion.removeClass('is-invalid');
                    }

                    // Validar universidad
                    var universidad = $(this).find('input[id*="universidad"]');
                    if (universidad.length > 0 && !universidad.val().trim()) {
                        isValid = false;
                        universidad.addClass('is-invalid');
                        errorMessages.push('Formación Académica ' + acadNum + ': La Universidad es obligatoria.');
                    } else {
                        universidad.removeClass('is-invalid');
                    }

                    // Validar fecha de grado
                    var fechaGrado = $(this).find('input[id*="fecha_grado"]');
                    if (fechaGrado.length > 0 && !fechaGrado.val()) {
                        isValid = false;
                        fechaGrado.addClass('is-invalid');
                        errorMessages.push('Formación Académica ' + acadNum + ': La Fecha de Grado es obligatoria.');
                    } else {
                        fechaGrado.removeClass('is-invalid');
                    }
                }
            });

            // Validar campos obligatorios de Posgrado (solo si el usuario empezó a llenarlo)
            $('.posgrado-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                // Solo validar si el formulario no está marcado para eliminar
                if (!deleteCheckbox.prop('checked')) {
                    var posNum = index + 1;

                    var nombrePosgrado = $(this).find('input[id*="nombre_posgrado"]');
                    var universidad = $(this).find('input[id*="universidad"]');
                    var fechaTerminacion = $(this).find('input[id*="fecha_terminacion"]');
                    var fileInput = $(this).find('input[type="file"][id*="acta_grado_diploma"]');

                    // Verificar si el usuario empezó a llenar algún campo
                    var tieneNombre = nombrePosgrado.length > 0 && nombrePosgrado.val().trim();
                    var tieneUniversidad = universidad.length > 0 && universidad.val().trim();
                    var tieneFecha = fechaTerminacion.length > 0 && fechaTerminacion.val();

                    // Solo validar si al menos un campo tiene valor
                    if (tieneNombre || tieneUniversidad || tieneFecha) {
                        // Validar nombre del posgrado
                        if (!tieneNombre) {
                            isValid = false;
                            nombrePosgrado.addClass('is-invalid');
                            errorMessages.push('Posgrado ' + posNum + ': El Nombre del Posgrado es obligatorio.');
                        } else {
                            nombrePosgrado.removeClass('is-invalid');
                        }

                        // Validar universidad
                        if (!tieneUniversidad) {
                            isValid = false;
                            universidad.addClass('is-invalid');
                            errorMessages.push('Posgrado ' + posNum + ': La Universidad es obligatoria.');
                        } else {
                            universidad.removeClass('is-invalid');
                        }

                        // Validar fecha de terminación
                        if (!tieneFecha) {
                            isValid = false;
                            fechaTerminacion.addClass('is-invalid');
                            errorMessages.push('Posgrado ' + posNum + ': La Fecha de Terminación es obligatoria.');
                        } else {
                            fechaTerminacion.removeClass('is-invalid');
                        }
                        
                        // Validar archivo
                        if (!fileInput.val()) {
                            isValid = false;
                            fileInput.addClass('is-invalid');
                            errorMessages.push('Posgrado ' + posNum + ': Debe adjuntar el acta de grado o diploma.');
                        } else {
                            fileInput.removeClass('is-invalid');
                        }
                    }
                }
            });

            // Validar campos obligatorios de Especialización (solo si el usuario empezó a llenarlo)
            $('.especializacion-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                // Solo validar si el formulario no está marcado para eliminar
                if (!deleteCheckbox.prop('checked')) {
                    var espNum = index + 1;

                    var nombreEspecializacion = $(this).find('input[id*="nombre_especializacion"]');
                    var universidad = $(this).find('input[id*="universidad"]');
                    var fechaTerminacion = $(this).find('input[id*="fecha_terminacion"]');
                    var fileInput = $(this).find('input[type="file"][id*="acta_grado_diploma"]');

                    // Verificar si el usuario empezó a llenar algún campo
                    var tieneNombre = nombreEspecializacion.length > 0 && nombreEspecializacion.val().trim();
                    var tieneUniversidad = universidad.length > 0 && universidad.val().trim();
                    var tieneFecha = fechaTerminacion.length > 0 && fechaTerminacion.val();

                    // Solo validar si al menos un campo tiene valor
                    if (tieneNombre || tieneUniversidad || tieneFecha) {
                        // Validar nombre de la especialización
                        if (!tieneNombre) {
                            isValid = false;
                            nombreEspecializacion.addClass('is-invalid');
                            errorMessages.push('Especialización ' + espNum + ': El Nombre de la Especialización es obligatorio.');
                        } else {
                            nombreEspecializacion.removeClass('is-invalid');
                        }

                        // Validar universidad
                        if (!tieneUniversidad) {
                            isValid = false;
                            universidad.addClass('is-invalid');
                            errorMessages.push('Especialización ' + espNum + ': La Universidad es obligatoria.');
                        } else {
                            universidad.removeClass('is-invalid');
                        }

                        // Validar fecha de terminación
                        if (!tieneFecha) {
                            isValid = false;
                            fechaTerminacion.addClass('is-invalid');
                            errorMessages.push('Especialización ' + espNum + ': La Fecha de Terminación es obligatoria.');
                        } else {
                            fechaTerminacion.removeClass('is-invalid');
                        }
                        
                        // Validar archivo
                        if (!fileInput.val()) {
                            isValid = false;
                            fileInput.addClass('is-invalid');
                            errorMessages.push('Especialización ' + espNum + ': Debe adjuntar el acta de grado o diploma.');
                        } else {
                            fileInput.removeClass('is-invalid');
                        }
                    }
                }
            });

            // Validar campos obligatorios de Educación Básica (Bachiller)
            $('.basica-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                if (!deleteCheckbox.prop('checked')) {
                    var num = index + 1;
                    var institucion = $(this).find('input[id*="institucion"]');
                    var anio = $(this).find('input[id*="anio_grado"]');
                    var fileInput = $(this).find('input[type="file"][id*="acta_grado_diploma"]');
                    
                    var tieneTexto = (institucion.val() && institucion.val().trim()) || (anio.val() && anio.val().trim());
                    
                    if (tieneTexto) {
                        if (!fileInput.val()) {
                            isValid = false;
                            fileInput.addClass('is-invalid');
                            errorMessages.push('Bachiller ' + num + ': Debe adjuntar el acta de grado o diploma.');
                        } else {
                            fileInput.removeClass('is-invalid');
                        }
                    }
                }
            });

            // Validar campos obligatorios de Educación Superior (Técnico/Tecnólogo)
            $('.superior-group:visible').each(function(index) {
                var deleteCheckbox = $(this).find('input[name$="-DELETE"]');
                if (!deleteCheckbox.prop('checked')) {
                    var num = index + 1;
                    var institucion = $(this).find('input[id*="institucion"]');
                    var titulo = $(this).find('input[id*="titulo"]');
                    var fileInput = $(this).find('input[type="file"][id*="documento_soporte"]');
                    
                    var tieneTexto = (institucion.val() && institucion.val().trim()) || (titulo.val() && titulo.val().trim());
                    
                    if (tieneTexto) {
                        if (!fileInput.val()) {
                            isValid = false;
                            fileInput.addClass('is-invalid');
                            errorMessages.push('Técnico/Tecnólogo ' + num + ': Debe adjuntar el diploma o acta de grado.');
                        } else {
                            fileInput.removeClass('is-invalid');
                        }
                    }
                }
            });

            // Validar certificados de antecedentes (todos obligatorios)
            var antecedentes = [
                { campo: 'certificado_procuraduria', nombre: 'Certificado de Procuraduría' },
                { campo: 'certificado_contraloria', nombre: 'Certificado de Contraloría' },
                { campo: 'certificado_policia', nombre: 'Certificado de Policía' },
                { campo: 'certificado_medidas_correctivas', nombre: 'Certificado de Medidas Correctivas' },
                { campo: 'certificado_delitos_sexuales', nombre: 'Certificado de Delitos Sexuales' },
                { campo: 'certificado_redam', nombre: 'Certificado REDAM' }
            ];

            antecedentes.forEach(function(antecedente) {
                var fileInput = $('input[type="file"][id*="' + antecedente.campo + '"]');
                if (fileInput.length > 0 && !fileInput.val()) {
                    isValid = false;
                    fileInput.addClass('is-invalid');
                    errorMessages.push('Debe adjuntar el ' + antecedente.nombre + '.');
                } else {
                    fileInput.removeClass('is-invalid');
                }
            });

            // Validar aceptación de política
            var politicaCheckbox = $('#id_acepta_politica');
            if (!politicaCheckbox.is(':checked')) {
                isValid = false;
                politicaCheckbox.addClass('is-invalid');
                errorMessages.push('Debe aceptar la política de tratamiento de datos para continuar.');
            } else {
                politicaCheckbox.removeClass('is-invalid');
            }

            if (!isValid) {
                e.preventDefault();
                alert('Por favor corrija los siguientes errores:\n\n' + errorMessages.join('\n'));

                // Hacer scroll al primer error
                var firstInvalid = $('.is-invalid').first();
                if (firstInvalid.length && firstInvalid.offset()) {
                    $('html, body').animate({
                        scrollTop: firstInvalid.offset().top - 100
                    }, 500);
                }
            } else {
                // Si el formulario es válido, mostrar el modal de carga
                var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                loadingModal.show();
            }
        });

        // Quitar el borde rojo cuando el usuario seleccione un archivo o escriba en un campo
        $(document).on('change', 'input[type="file"]', function() {
            if ($(this).val()) {
                $(this).removeClass('is-invalid');
            }
            
            // Validar tamaño y extensión del archivo
            var file = this.files[0];
            if (file) {
                var maxSize = 10 * 1024 * 1024; // 10 MB
                var validExtensions = ['pdf', 'jpg', 'jpeg', 'png'];
                var extension = file.name.split('.').pop().toLowerCase();
                
                if (file.size > maxSize) {
                    alert('El archivo excede el tamaño máximo permitido de 10 MB.');
                    $(this).val(''); // Limpiar input
                    return;
                }
                
                if ($.inArray(extension, validExtensions) == -1) {
                    alert('Tipo de archivo no válido. Solo se permiten: PDF, JPG, PNG.');
                    $(this).val(''); // Limpiar input
                    return;
                }
            }
        });

        // Quitar borde rojo en campos de texto al escribir
        $(document).on('input', 'input[type="text"], input[type="email"], input[type="number"], input[type="date"], select, textarea', function() {
            if ($(this).val().trim()) {
                $(this).removeClass('is-invalid');
            }
        });

        // Manejar clic en botón Aceptar del modal de política
        $('#btnAceptarPolitica').on('click', function() {
            // Marcar el checkbox de aceptación de política
            $('#id_acepta_politica').prop('checked', true);
            // Remover el borde de error si existía
            $('#id_acepta_politica').removeClass('is-invalid');
            // El modal se cierra automáticamente con data-bs-dismiss="modal"
            console.log('Checkbox marcado: ', $('#id_acepta_politica').is(':checked'));
        });
    });
</script>
{% endblock %}
