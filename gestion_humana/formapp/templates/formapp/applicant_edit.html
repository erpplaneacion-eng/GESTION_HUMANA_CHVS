{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Registro - {{ applicant.nombre_completo }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-warning text-white">
            <h3 class="mb-0"><i class="fas fa-edit"></i> Editar Registro - {{ applicant.cedula }}</h3>
        </div>
        <div class="card-body">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="editForm">
                {% csrf_token %}

                <!-- Sección 1: Información Personal -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-user"></i> Información Personal</h4>
                    </div>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.primer_apellido.label }}</label>
                                {{ form.primer_apellido }}
                                {% if form.primer_apellido.errors %}
                                    <div class="text-danger">{{ form.primer_apellido.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.segundo_apellido.label }}</label>
                                {{ form.segundo_apellido }}
                                {% if form.segundo_apellido.errors %}
                                    <div class="text-danger">{{ form.segundo_apellido.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.primer_nombre.label }}</label>
                                {{ form.primer_nombre }}
                                {% if form.primer_nombre.errors %}
                                    <div class="text-danger">{{ form.primer_nombre.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.segundo_nombre.label }}</label>
                                {{ form.segundo_nombre }}
                                {% if form.segundo_nombre.errors %}
                                    <div class="text-danger">{{ form.segundo_nombre.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.cedula.label }}</label>
                                {{ form.cedula }}
                                {% if form.cedula.errors %}
                                    <div class="text-danger">{{ form.cedula.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ form.genero.label }}</label>
                                {{ form.genero }}
                                {% if form.genero.errors %}
                                    <div class="text-danger">{{ form.genero.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.tipo_via.label }}</label>
                                {{ form.tipo_via }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.numero_via.label }}</label>
                                {{ form.numero_via }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.numero_casa.label }}</label>
                                {{ form.numero_casa }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">{{ form.complemento_direccion.label }}</label>
                                {{ form.complemento_direccion }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.barrio.label }}</label>
                                {{ form.barrio }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.telefono.label }}</label>
                                {{ form.telefono }}
                                {% if form.telefono.errors %}
                                    <div class="text-danger">{{ form.telefono.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">{{ form.correo.label }}</label>
                                {{ form.correo }}
                                {% if form.correo.errors %}
                                    <div class="text-danger">{{ form.correo.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Administrativa (Solo para personal administrativo) -->
                <div class="admin-section">
                    <div class="admin-section-header">
                        <h4><i class="fas fa-user-shield"></i> Información Administrativa (Solo Personal Autorizado)</h4>
                    </div>
                    <div class="admin-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Nota:</strong> Los campos resaltados en amarillo son exclusivos para ser completados por el personal administrativo.
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.perfil.label }}</label>
                            <select name="perfil" id="id_perfil" class="form-control admin-field">
                                <option value="">-- Seleccione --</option>
                                {% for choice in form.perfil.field.choices %}
                                    {% if choice.0 %}
                                    <option value="{{ choice.0 }}" {% if form.perfil.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="perfil_otro_container" style="{% if form.perfil.value != 'OTRO' %}display: none;{% endif %}">
                            <label class="form-label">Especifique Perfil</label>
                            <input type="text" name="perfil_otro" value="{{ form.perfil_otro.value|default:'' }}" class="form-control admin-field" style="text-transform: uppercase;" placeholder="Escriba el perfil">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.area_del_conocimiento.label }}</label>
                            <select name="area_del_conocimiento" id="id_area_del_conocimiento" class="form-control admin-field">
                                <option value="">-- Seleccione --</option>
                                {% for choice in form.area_del_conocimiento.field.choices %}
                                    {% if choice.0 %}
                                    <option value="{{ choice.0 }}" {% if form.area_del_conocimiento.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="area_otro_container" style="{% if form.area_del_conocimiento.value != 'OTRO' %}display: none;{% endif %}">
                            <label class="form-label">Especifique Area</label>
                            <input type="text" name="area_del_conocimiento_otro" value="{{ form.area_del_conocimiento_otro.value|default:'' }}" class="form-control admin-field" style="text-transform: uppercase;" placeholder="Escriba el area">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.profesion.label }}</label>
                            <select name="profesion" id="id_profesion" class="form-control admin-field">
                                <option value="">-- Seleccione --</option>
                                {% for choice in form.profesion.field.choices %}
                                    {% if choice.0 %}
                                    <option value="{{ choice.0 }}" {% if form.profesion.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="profesion_otro_container" style="{% if form.profesion.value != 'OTRO' %}display: none;{% endif %}">
                            <label class="form-label">Especifique Profesion</label>
                            <input type="text" name="profesion_otro" value="{{ form.profesion_otro.value|default:'' }}" class="form-control admin-field" style="text-transform: uppercase;" placeholder="Escriba la profesion">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.contrato.label }}</label>
                            <input type="text" name="contrato" value="{{ form.contrato.value|default:'' }}" class="form-control admin-field">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">{{ form.observacion.label }}</label>
                            <textarea name="observacion" class="form-control admin-field" rows="3">{{ form.observacion.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Sección: Documentos de Identidad y Autorización -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-id-card"></i> Documentos de Identidad y Autorización</h4>
                    </div>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fotocopia de Cédula</label>
                                {{ documentos_form.fotocopia_cedula }}
                                {% if documentos_form.instance.fotocopia_cedula %}
                                    <small class="text-muted d-block mt-1">
                                        Actual: <a href="{{ documentos_form.instance.fotocopia_cedula.url }}" target="_blank">Ver documento</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Carta de Autorización de Datos</label>
                                {{ documentos_form.carta_autorizacion_datos }}
                                {% if documentos_form.instance.carta_autorizacion_datos %}
                                    <small class="text-muted d-block mt-1">
                                        Actual: <a href="{{ documentos_form.instance.carta_autorizacion_datos.url }}" target="_blank">Ver documento</a>
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha de Autorización</label>
                                {{ documentos_form.fecha_autorizacion }}
                            </div>
                        </div>

                        <!-- Campos de Libreta Militar -->
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-shield-alt"></i> Situación Militar (Opcional)</h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Libreta Militar</label>
                                {{ documentos_form.libreta_militar }}
                                {% if documentos_form.instance.libreta_militar %}
                                    <small class="text-muted d-block mt-1">
                                        Actual: <a href="{{ documentos_form.instance.libreta_militar.url }}" target="_blank">Ver documento</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Número de Libreta Militar</label>
                                {{ documentos_form.numero_libreta_militar }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distrito Militar</label>
                                {{ documentos_form.distrito_militar }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Clase de Libreta</label>
                                {{ documentos_form.clase_libreta }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Antecedentes y Verificaciones -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-clipboard-check"></i> Antecedentes y Verificaciones</h4>
                    </div>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Certificado Procuraduría</label>
                                {{ antecedentes_form.certificado_procuraduria }}
                                {% if antecedentes_form.instance.certificado_procuraduria %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ antecedentes_form.instance.certificado_procuraduria.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Procuraduría</label>
                                {{ antecedentes_form.fecha_procuraduria }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Certificado Contraloría</label>
                                {{ antecedentes_form.certificado_contraloria }}
                                {% if antecedentes_form.instance.certificado_contraloria %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ antecedentes_form.instance.certificado_contraloria.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Contraloría</label>
                                {{ antecedentes_form.fecha_contraloria }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Certificado Policía Nacional</label>
                                {{ antecedentes_form.certificado_policia }}
                                {% if antecedentes_form.instance.certificado_policia %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ antecedentes_form.instance.certificado_policia.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Policía</label>
                                {{ antecedentes_form.fecha_policia }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Certificado Medidas Correctivas (RNMC)</label>
                                {{ antecedentes_form.certificado_medidas_correctivas }}
                                {% if antecedentes_form.instance.certificado_medidas_correctivas %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ antecedentes_form.instance.certificado_medidas_correctivas.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Medidas Correctivas</label>
                                {{ antecedentes_form.fecha_medidas_correctivas }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Certificado Delitos Sexuales</label>
                                {{ antecedentes_form.certificado_delitos_sexuales }}
                                {% if antecedentes_form.instance.certificado_delitos_sexuales %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ antecedentes_form.instance.certificado_delitos_sexuales.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Delitos Sexuales</label>
                                {{ antecedentes_form.fecha_delitos_sexuales }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Anexos Adicionales -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-paperclip"></i> Anexos Adicionales</h4>
                    </div>
                    <div class="section-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ANEXO 03 - Datos Personales</label>
                                {{ anexos_form.anexo_03_datos_personales }}
                                {% if anexos_form.instance.anexo_03_datos_personales %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ anexos_form.instance.anexo_03_datos_personales.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Carta de Intención</label>
                                {{ anexos_form.carta_intencion }}
                                {% if anexos_form.instance.carta_intencion %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ anexos_form.instance.carta_intencion.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Otros Documentos</label>
                                {{ anexos_form.otros_documentos }}
                                {% if anexos_form.instance.otros_documentos %}
                                    <small class="text-muted d-block mt-1">
                                        <a href="{{ anexos_form.instance.otros_documentos.url }}" target="_blank">Ver actual</a>
                                    </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Descripción de Otros Documentos</label>
                                {{ anexos_form.descripcion_otros }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección 2: Experiencia Laboral -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-briefcase"></i> Experiencia Laboral</h4>
                    </div>
                    <div class="section-body">
                        {{ experiencia_formset.management_form }}
                        <div id="experiencia-formset">
                            {% for form_exp in experiencia_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_exp.id.value and not form_exp.cargo.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Experiencia #{{ forloop.counter }}</h5>
                                    {{ form_exp.id }}
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fecha Inicial</label>
                                            {{ form_exp.fecha_inicial }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fecha de Terminación</label>
                                            {{ form_exp.fecha_terminacion }}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label class="form-label">Meses</label>
                                            {{ form_exp.meses_experiencia }}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label class="form-label">Días</label>
                                            {{ form_exp.dias_experiencia }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Cargo</label>
                                            {{ form_exp.cargo }}
                                        </div>
                                    </div>
                                    <div class="row" style="display: none;">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Cargo Anexo 11</label>
                                            {{ form_exp.cargo_anexo_11 }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Objeto Contractual</label>
                                            {{ form_exp.objeto_contractual }}
                                            {% if form_exp.objeto_contractual.help_text %}
                                                <small class="form-text text-warning d-block mt-1">
                                                    <i class="fas fa-info-circle"></i> {{ form_exp.objeto_contractual.help_text }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Funciones</label>
                                            {{ form_exp.funciones }}
                                            {% if form_exp.funciones.help_text %}
                                                <small class="form-text text-warning d-block mt-1">
                                                    <i class="fas fa-info-circle"></i> {{ form_exp.funciones.help_text }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Certificado Laboral</label>
                                            {{ form_exp.certificado_laboral }}
                                            {% if form_exp.instance.certificado_laboral %}
                                                <div class="mt-2">
                                                    <small class="text-muted">
                                                        Archivo actual: <a href="{{ form_exp.instance.certificado_laboral.url }}" target="_blank">{{ form_exp.instance.certificado_laboral.name }}</a>
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {{ form_exp.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-experiencia-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Más Experiencia
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección 2.1: Educación Básica (Bachiller) -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-school"></i> Educación Básica (Bachiller)</h4>
                    </div>
                    <div class="section-body">
                        {{ basica_formset.management_form }}
                        <div id="basica-formset">
                            {% for form_bas in basica_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_bas.id.value and not form_bas.titulo.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Bachiller #{{ forloop.counter }}</h5>
                                    {{ form_bas.id }}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Institución</label>
                                            {{ form_bas.institucion }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Año de Grado</label>
                                            {{ form_bas.anio_grado }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Título</label>
                                            {{ form_bas.titulo }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Acta de Grado / Diploma</label>
                                            {{ form_bas.acta_grado_diploma }}
                                            {% if form_bas.instance.acta_grado_diploma %}
                                                <div class="mt-2">
                                                    <small class="text-muted">
                                                        Archivo actual: <a href="{{ form_bas.instance.acta_grado_diploma.url }}" target="_blank">{{ form_bas.instance.acta_grado_diploma.name }}</a>
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {{ form_bas.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-basica-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Bachiller
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección 2.2: Educación Superior (Técnico/Tecnólogo) -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-cogs"></i> Educación Superior (Técnico/Tecnólogo)</h4>
                    </div>
                    <div class="section-body">
                        {{ superior_formset.management_form }}
                        <div id="superior-formset">
                            {% for form_sup in superior_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_sup.id.value and not form_sup.titulo.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Título #{{ forloop.counter }}</h5>
                                    {{ form_sup.id }}
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Nivel</label>
                                            {{ form_sup.nivel }}
                                        </div>
                                        <div class="col-md-5 mb-3">
                                            <label class="form-label">Institución</label>
                                            {{ form_sup.institucion }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Título</label>
                                            {{ form_sup.titulo }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fecha Grado</label>
                                            {{ form_sup.fecha_grado }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Tarjeta Profesional</label>
                                            {{ form_sup.tarjeta_profesional }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Documento Soporte</label>
                                            {{ form_sup.documento_soporte }}
                                            {% if form_sup.instance.documento_soporte %}
                                                <div class="mt-2">
                                                    <small class="text-muted">
                                                        Archivo actual: <a href="{{ form_sup.instance.documento_soporte.url }}" target="_blank">{{ form_sup.instance.documento_soporte.name }}</a>
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {{ form_sup.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-superior-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Técnico/Tecnólogo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección 3: Formación Académica -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-graduation-cap"></i> Formación Académica</h4>
                    </div>
                    <div class="section-body">
                        {{ academica_formset.management_form }}
                        <div id="academica-formset">
                            {% for form_aca in academica_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_aca.id.value and not form_aca.profesion.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Formación #{{ forloop.counter }}</h5>
                                    {{ form_aca.id }}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Profesión</label>
                                            {{ form_aca.profesion }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Universidad</label>
                                            {{ form_aca.universidad }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fecha de Grado</label>
                                            {{ form_aca.fecha_grado }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Tipo de Tarjeta/Resolución</label>
                                            {{ form_aca.tarjeta_profesional }}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">N° Tarjeta o Resolución</label>
                                            {{ form_aca.numero_tarjeta_resolucion }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Expedición</label>
                                            {{ form_aca.fecha_expedicion }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Meses de Experiencia por Profesión</label>
                                            {{ form_aca.meses_experiencia_profesion }}
                                        </div>
                                    </div>
                                    {{ form_aca.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-academica-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Más Formación Académica
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección 4: Posgrados -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-award"></i> Posgrados (Maestrías, Doctorados)</h4>
                    </div>
                    <div class="section-body">
                        {{ posgrado_formset.management_form }}
                        <div id="posgrado-formset">
                            {% for form_pos in posgrado_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_pos.id.value and not form_pos.nombre_posgrado.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Posgrado #{{ forloop.counter }}</h5>
                                    {{ form_pos.id }}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nombre del Posgrado</label>
                                            {{ form_pos.nombre_posgrado }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Universidad</label>
                                            {{ form_pos.universidad }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Terminación</label>
                                            {{ form_pos.fecha_terminacion }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Meses de Experiencia</label>
                                            {{ form_pos.meses_de_experiencia }}
                                        </div>
                                    </div>
                                    {{ form_pos.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-posgrado-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Más Posgrados
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección 5: Especializaciones -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h4><i class="fas fa-certificate"></i> Especializaciones</h4>
                    </div>
                    <div class="section-body">
                        {{ especializacion_formset.management_form }}
                        <div id="especializacion-formset">
                            {% for form_esp in especializacion_formset %}
                                <div class="formset-form mb-4 p-3 border rounded" {% if not form_esp.id.value and not form_esp.nombre_especializacion.value %}style="display: none;"{% endif %}>
                                    <h5 class="mb-3">Especialización #{{ forloop.counter }}</h5>
                                    {{ form_esp.id }}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nombre de la Especialización</label>
                                            {{ form_esp.nombre_especializacion }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Universidad</label>
                                            {{ form_esp.universidad }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fecha de Terminación</label>
                                            {{ form_esp.fecha_terminacion }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Meses de Experiencia</label>
                                            {{ form_esp.meses_de_experiencia }}
                                        </div>
                                    </div>
                                    {{ form_esp.DELETE }}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-primary" id="add-especializacion-edit">
                                <i class="fas fa-plus-circle"></i> Agregar Más Especializaciones
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="text-center mb-4">
                    <button type="submit" class="btn btn-warning btn-lg me-2">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <a href="{% url 'formapp:applicant_list' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Manejar campos "Otro" para selects administrativos
document.addEventListener('DOMContentLoaded', function() {
    // Función para mostrar/ocultar campos "otro"
    function toggleOtroField(selectId, containerId) {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        if (select && container) {
            if (select.value === 'OTRO') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
    }

    // Configurar listeners para los selects
    const perfilSelect = document.getElementById('id_perfil');
    const areaSelect = document.getElementById('id_area_del_conocimiento');
    const profesionSelect = document.getElementById('id_profesion');

    if (perfilSelect) {
        perfilSelect.addEventListener('change', function() {
            toggleOtroField('id_perfil', 'perfil_otro_container');
        });
    }

    if (areaSelect) {
        areaSelect.addEventListener('change', function() {
            toggleOtroField('id_area_del_conocimiento', 'area_otro_container');
        });
    }

    if (profesionSelect) {
        profesionSelect.addEventListener('change', function() {
            toggleOtroField('id_profesion', 'profesion_otro_container');
        });
    }

    // Convertir a mayúsculas los campos "otro"
    document.querySelectorAll('input[name$="_otro"]').forEach(function(input) {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
});

// Ocultar formularios vacíos al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Ocultar formularios vacíos de experiencia
    document.querySelectorAll('#experiencia-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const cargoField = form.querySelector('[name*="-cargo"]');
        if (idField && !idField.value && cargoField && !cargoField.value) {
            form.style.display = 'none';
        }
    });

    // Ocultar formularios vacíos de formación académica
    document.querySelectorAll('#academica-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const profesionField = form.querySelector('[name*="-profesion"]');
        if (idField && !idField.value && profesionField && !profesionField.value) {
            form.style.display = 'none';
        }
    });

    // Ocultar formularios vacíos de posgrados
    document.querySelectorAll('#posgrado-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const nombreField = form.querySelector('[name*="-nombre_posgrado"]');
        if (idField && !idField.value && nombreField && !nombreField.value) {
            form.style.display = 'none';
        }
    });

    // Ocultar formularios vacíos de especializaciones
    document.querySelectorAll('#especializacion-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const nombreField = form.querySelector('[name*="-nombre_especializacion"]');
        if (idField && !idField.value && nombreField && !nombreField.value) {
            form.style.display = 'none';
        }
    });
    // Ocultar formularios vacíos de bachiller
    document.querySelectorAll('#basica-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const tituloField = form.querySelector('[name*="-titulo"]');
        if (idField && !idField.value && tituloField && !tituloField.value) {
            form.style.display = 'none';
        }
    });

    // Ocultar formularios vacíos de superior
    document.querySelectorAll('#superior-formset .formset-form').forEach(function(form) {
        const idField = form.querySelector('[name*="-id"]');
        const tituloField = form.querySelector('[name*="-titulo"]');
        if (idField && !idField.value && tituloField && !tituloField.value) {
            form.style.display = 'none';
        }
    });
});

// Cálculo automático de meses y días de experiencia
document.addEventListener('DOMContentLoaded', function() {
    const formset = document.getElementById('experiencia-formset');

    if (formset) {
        formset.addEventListener('change', function(e) {
            const target = e.target;

            if (target.name && (target.name.includes('fecha_inicial') || target.name.includes('fecha_terminacion'))) {
                const formDiv = target.closest('.formset-form');
                const fechaInicial = formDiv.querySelector('[name*="fecha_inicial"]').value;
                const fechaTerminacion = formDiv.querySelector('[name*="fecha_terminacion"]').value;

                if (fechaInicial && fechaTerminacion) {
                    const resultado = calcularDiferencia(fechaInicial, fechaTerminacion);
                    formDiv.querySelector('[name*="meses_experiencia"]').value = resultado.meses;
                    formDiv.querySelector('[name*="dias_experiencia"]').value = resultado.totalDias;
                }
            }
        });
    }
});

function calcularDiferencia(fechaInicio, fechaFin) {
    var inicio = new Date(fechaInicio);
    var fin = new Date(fechaFin);

    var unDiaEnMilisegundos = 1000 * 60 * 60 * 24;
    var totalDias = Math.round((fin - inicio) / unDiaEnMilisegundos);

    var años = fin.getFullYear() - inicio.getFullYear();
    var meses = fin.getMonth() - inicio.getMonth();
    var dias = fin.getDate() - inicio.getDate();

    if (dias < 0) {
        meses--;
        var ultimoDiaMesAnterior = new Date(fin.getFullYear(), fin.getMonth(), 0).getDate();
        dias += ultimoDiaMesAnterior;
    }

    if (meses < 0) {
        años--;
        meses += 12;
    }

    var totalMeses = (años * 12) + meses;

    return {
        meses: totalMeses,
        dias: dias,
        totalDias: totalDias
    };
}

// Funciones para agregar más formularios en la vista de edición
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si jQuery está disponible
    if (typeof jQuery === 'undefined') {
        console.error('jQuery no está disponible');
        return;
    }
    
    var $ = jQuery;
    // Función para agregar más experiencias
    $('#add-experiencia-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#experiencia-formset');
        var totalForms = $('#id_experiencias_laborales-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        // Buscar el último formulario visible o disponible
        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).last();
        }
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).first();
        }

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/experiencias_laborales-\d+-/g, 'experiencias_laborales-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="file"]').val('');
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            // Actualizar el título
            newForm.find('h5').text('Experiencia #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });

    // Función para agregar más formación académica
    $('#add-academica-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#academica-formset');
        var totalForms = $('#id_formacion_academica-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).last();
        }
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).first();
        }

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/formacion_academica-\d+-/g, 'formacion_academica-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            newForm.find('h5').text('Formación #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });

    // Función para agregar más posgrados
    $('#add-posgrado-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#posgrado-formset');
        var totalForms = $('#id_posgrados-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).last();
        }
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).first();
        }

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/posgrados-\d+-/g, 'posgrados-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            newForm.find('h5').text('Posgrado #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });

    // Función para agregar más especializaciones
    $('#add-especializacion-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#especializacion-formset');
        var totalForms = $('#id_especializaciones-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).last();
        }
        if (lastForm.length === 0) {
            lastForm = $('.formset-form', formsetContainer).first();
        }

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/especializaciones-\d+-/g, 'especializaciones-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            newForm.find('h5').text('Especialización #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });

    // Función para agregar más bachiller
    $('#add-basica-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#basica-formset');
        var totalForms = $('#id_educacion_basica-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) lastForm = $('.formset-form', formsetContainer).last();
        if (lastForm.length === 0) lastForm = $('.formset-form', formsetContainer).first();

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/educacion_basica-\d+-/g, 'educacion_basica-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            newForm.find('h5').text('Bachiller #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });

    // Función para agregar más superior
    $('#add-superior-edit').on('click', function(e) {
        e.preventDefault();
        var formsetContainer = $('#superior-formset');
        var totalForms = $('#id_educacion_superior-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());

        var lastForm = $('.formset-form:visible', formsetContainer).last();
        if (lastForm.length === 0) lastForm = $('.formset-form', formsetContainer).last();
        if (lastForm.length === 0) lastForm = $('.formset-form', formsetContainer).first();

        if (lastForm.length > 0) {
            var newForm = lastForm.clone();
            newForm.html(newForm.html().replace(/educacion_superior-\d+-/g, 'educacion_superior-' + formNum + '-'));
            newForm.find('input, textarea, select').val('');
            newForm.find('input[type="checkbox"]').prop('checked', false);
            newForm.find('input[type="hidden"][name*="-id"]').remove();
            newForm.show();
            
            newForm.find('h5').text('Título #' + (formNum + 1));
            
            formsetContainer.append(newForm);
            totalForms.val(formNum + 1);
        }
    });
});
</script>
{% endblock %}
